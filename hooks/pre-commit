#!/bin/bash

# GuardedEthTokenSwapper Pre-Commit Hook
# Automatically formats Solidity files before commit

echo "üîç Running pre-commit checks..."

# Check if forge is installed
if ! command -v forge &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: forge not found. Skipping format check."
    echo "   Install Foundry: https://getfoundry.sh/"
    exit 0
fi

# Get list of staged Solidity files
STAGED_SOL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sol)$' || true)

if [ -z "$STAGED_SOL_FILES" ]; then
    echo "‚úÖ No Solidity files to format"
    exit 0
fi

echo "üìù Formatting Solidity files..."

# Run forge fmt on the entire project
forge fmt

# Check if formatting changed any files
CHANGED_FILES=$(git diff --name-only | grep -E '\.(sol)$' || true)

if [ -n "$CHANGED_FILES" ]; then
    echo ""
    echo "‚ú® Formatted files:"
    echo "$CHANGED_FILES" | sed 's/^/   ‚Ä¢ /'
    echo ""
    echo "üìù Re-staging formatted files..."
    
    # Re-stage the formatted files
    echo "$CHANGED_FILES" | xargs git add
    
    echo "‚úÖ Formatting complete and changes staged"
else
    echo "‚úÖ All files already properly formatted"
fi

echo ""
exit 0

